name: test build status change
on:
  push:
    branches:
      - experimental/run_status

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: run
        run: |
          echo "Hello, world! 3"
      - name: Get Previous Run Status
        id: previous_status
        uses: actions/github-script@v7
        with:
          result-encoding: string
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const path = require('path');
            let workflow_ref = process.env.GITHUB_WORKFLOW_REF;
            const workflow_id = path.basename(workflow_ref.split('@')[0]);

            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow_id,
              per_page: 2,
              page: 1,
            });
            return runs.workflow_runs[1].conclusion;

      - name: Check Status Change
        id: check_status_change
        run: echo "Build back to normal"
        if: ${{ steps.previous_status.outputs.result != 'success' && success() }}

      - name: Echo fail
        run: echo "Build failed"
        if: ${{ failure() && !cancelled() }}
